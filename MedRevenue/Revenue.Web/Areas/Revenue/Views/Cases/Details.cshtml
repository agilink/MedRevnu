@model ATI.Revenue.Application.Cases.Dtos.CaseDto
@{
    ViewData["Title"] = "Case Details";
}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">@ViewData["Title"]</h3>
                <div class="card-tools">
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <a asp-action="Index" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Case Number</dt>
                    <dd class="col-sm-9">@Model.CaseNumber</dd>

                    <dt class="col-sm-3">Client Name</dt>
                    <dd class="col-sm-9">@Model.ClientName</dd>

                    <dt class="col-sm-3">Case Date</dt>
                    <dd class="col-sm-9">@Model.CaseDate.ToString("MM/dd/yyyy")</dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        @{
                            var badgeClass = "secondary";
                            if (Model.Status == "Open") badgeClass = "success";
                            else if (Model.Status == "In Progress") badgeClass = "warning";
                            else if (Model.Status == "Closed") badgeClass = "danger";
                        }
                        <span class="badge bg-@badgeClass">@Model.Status</span>
                    </dd>

                    <dt class="col-sm-3">Total Amount</dt>
                    <dd class="col-sm-9">$@Model.TotalAmount.ToString("N2")</dd>

                    <dt class="col-sm-3">Description</dt>
                    <dd class="col-sm-9">@(Model.Description ?? "N/A")</dd>

                    <dt class="col-sm-3">Notes</dt>
                    <dd class="col-sm-9">@(Model.Notes ?? "N/A")</dd>
                </dl>

                <hr />
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Products</h5>
                    <button type="button" id="AddProductButton" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>

                <table class="table table-striped" id="ProductsTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Discount</th>
                            <th>Total</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.CaseProducts != null && Model.CaseProducts.Any())
                        {
                            @foreach (var product in Model.CaseProducts)
                            {
                                <tr data-product-id="@product.Id">
                                    <td>@product.ProductName</td>
                                    <td>@product.Quantity</td>
                                    <td>$@product.UnitPrice.ToString("N2")</td>
                                    <td>$@product.Discount.ToString("N2")</td>
                                    <td>$@product.TotalPrice.ToString("N2")</td>
                                    <td>
                                        <button type="button" class="btn btn-warning btn-sm edit-product me-1" data-product-id="@product.Id" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm remove-product" data-product-id="@product.Id" title="Remove">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr id="NoProductsRow">
                                <td colspan="6" class="text-center text-muted">No products added yet</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            var caseId = @Model.Id;

            // Initialize the product modal
            var _addOrEditProductModal = new app.ModalManager({
                viewUrl: abp.appPath + 'Revenue/Cases/AddOrEditProductModal',
                scriptUrl: abp.appPath + 'view-resources/Areas/Revenue/Views/Cases/_AddOrEditProductModal.js',
                modalClass: 'AddOrEditProductModal'
            });

            // Add Product Button Click
            $('#AddProductButton').click(function () {
                _addOrEditProductModal.open({ caseId: caseId });
            });

            // Edit Product Button Click
            $(document).on('click', '.edit-product', function () {
                var productId = $(this).data('product-id');
                _addOrEditProductModal.open({ caseId: caseId, productId: productId });
            });

            // Remove Product Button Click
            $(document).on('click', '.remove-product', function () {
                var productId = $(this).data('product-id');
                removeProduct(productId);
            });

            // Reload when product is saved
            abp.event.on('app.addOrEditProductModalSaved', function () {
                location.reload();
            });

            function removeProduct(caseProductId) {
                abp.message.confirm(
                    'Are you sure you want to remove this product?',
                    'Remove Product',
                    function (isConfirmed) {
                        if (isConfirmed) {
                            abp.ui.setBusy();

                            $.ajax({
                                url: abp.appPath + 'api/services/app/Cases/RemoveCaseProduct',
                                type: 'DELETE',
                                data: JSON.stringify({ id: caseProductId }),
                                contentType: 'application/json',
                                success: function () {
                                    abp.notify.success('Product removed successfully');
                                    location.reload();
                                },
                                error: function () {
                                    abp.notify.error('Failed to remove product');
                                },
                                complete: function () {
                                    abp.ui.clearBusy();
                                }
                            });
                        }
                    }
                );
            }
        });
    </script>
}
