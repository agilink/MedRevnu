(function ($) {
    app.modals.CreateOrEditDoctorModal = function () {
        var _doctorsService = abp.services.app.doctors;

        var _modalManager;
        var _$doctorInformationForm = null;
        var _$deleteButton = null;
        var _$doctorEle = null;
        var _$comapnyListDiv = $('.company-list');
        var _$comapnyNewDiv = $('.company-new');
        var _$newCompanyBtn = $('#create-company');
        var _$selectCompanyBtn = $('#select-company');
        var _$CanvasSignaturePad = $('#signature-pad');

        this.init = function (modalManager) {
            _modalManager = modalManager;

            var modal = _modalManager.getModal();
            modal.find('.date-picker').daterangepicker(app.createDateTimePickerOptions());
            modal.find('#companyddl').select2({
                theme: 'bootstrap5',
                placeholder: "Select Facilities",
                dropdownParent: '.modal',
                selectionCssClass: 'form-select',
                language: abp.localization.currentCulture.name,
                width: '100%',
                dropdownCssClass: "long-select2",
            });

            modal.find('#User_PhoneNumber').inputmask('(999) 999-9999');
            modal.find('#FaxNo').inputmask('(999) 999-9999');

            _$doctorEle = modal.find("#hdnDoctorId");
            _$deleteButton = modal.find('.delete-button');

            if (_$doctorEle.length > 0) {
                _$deleteButton.show();
            }
            else {
                _$deleteButton.hide();
            }
            //Delete Doctor
            _$deleteButton.click(function () {

                var doctor = _$doctorInformationForm.serializeFormToObject();
                abp.message.confirm('', app.localize('AreYouSure'), function (isConfirmed) {
                    if (isConfirmed) {
                        _modalManager.setBusy(true);
                        _doctorsService
                            .delete({
                                id: doctor.id,
                            })
                            .done(function () {
                                abp.notify.success(app.localize('SuccessfullyDeleted'));
                                _modalManager.close();
                                abp.event.trigger('app.doctorDataDeleted');
                            })
                            .always(function () {
                                _modalManager.setBusy(false);
                            });

                    }
                });
            });

            _$newCompanyBtn.click(function () {
                _$comapnyListDiv.addClass("hide");
                _$comapnyNewDiv.removeClass("hide");
                $('#companyddl').val(0);
            });

            _$selectCompanyBtn.click(function () {
                _$comapnyListDiv.removeClass("hide");
                _$comapnyNewDiv.addClass("hide");
                $('#Doctor_Company').val('');
            });

            _$doctorInformationForm = _modalManager.getModal().find('form[name=DoctorInformationsForm]');
            _$doctorInformationForm.validate();
        };

        this.save = function () {
            if (!_$doctorInformationForm.valid()) {
                return;
            }

            var doctor = _$doctorInformationForm.serializeFormToObject();

            doctor.phoneNumber = doctor.PhoneNumber.replace(/\D/g, '');
            doctor.faxNo = doctor.FaxNo.replace(/\D/g, '');

            if (doctor.SignatureFileID.length == 0 && _$CanvasSignaturePad.css('pointer-events') != "none") {
                abp.notify.error('Please save a signature first.');
                return;
            }

            _modalManager.setBusy(true);
            _doctorsService
                .createOrEdit(doctor)
                .done(function () {

                    abp.notify.success(app.localize('SavedSuccessfully'));
                    _modalManager.close();
                    abp.event.trigger('app.createOrEditDoctorModalSaved');
                })
                .always(function () {
                    _modalManager.setBusy(false);
                });
        };
    };
})(jQuery);
